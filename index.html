<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Emoji Dodge ‚Äì v3.5.1</title>
<meta name="theme-color" content="#0b0f1a" />
<style>
  :root{
    --bg:#080b14; --text:#f1f5ff; --muted:#9aa5c3; --gold:#ffd166; --red:#ff6b6b;
    --glass: rgba(255,255,255,.08); --glassBorder: rgba(255,255,255,.18);
    --safe-t: env(safe-area-inset-top, 0px);
    --safe-r: env(safe-area-inset-right, 0px);
    --safe-b: env(safe-area-inset-bottom, 0px);
    --safe-l: env(safe-area-inset-left, 0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 70% -10%, #1a2248, #080b14 60%);color:var(--text);font-family:ui-sans-serif,system-ui,Inter,Arial;overscroll-behavior:none}
  .wrap{display:flex;flex-direction:column;min-height:100dvh;padding:calc(var(--safe-t)) calc(var(--safe-r)) calc(var(--safe-b)) calc(var(--safe-l))}
  main{position:relative;flex:1;overflow:hidden}
  .stage{position:relative;width:100%;height:100%}
  canvas{position:absolute;display:block;border-radius:18px;border:1px solid rgba(255,255,255,.08);box-shadow:0 12px 40px rgba(0,0,0,.5);background: radial-gradient(800px 500px at 50% -100px, rgba(255,255,255,.05), transparent 60%), linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); touch-action:none; z-index:1}
  .hudBox{position:absolute;pointer-events:none; z-index:2}
  .score{position:absolute;left:50%;transform:translateX(-50%);top:8px;font-weight:900;font-size: clamp(24px, 6vw, 44px);text-shadow:0 4px 16px rgba(0,0,0,.45)}
  .bank{position:absolute;right:14px;top:10px;font-weight:800;opacity:.95;font-size: clamp(14px, 3.2vw, 20px)}
  .modeIcon{position:absolute;left:14px;top:10px;font-size: clamp(22px, 4.5vw, 34px)}
  .morphBadge{position:absolute;left:50%;top:48px;transform:translateX(-50%);font-weight:900;background:var(--glass);border:1px solid var(--glassBorder);padding:6px 10px;border-radius:999px;display:none}
  .morphBadge.show{display:block}
  .event{position:absolute;left:50%;top:18%;transform:translateX(-50%);font-weight:900;font-size: clamp(20px,3.6vw,32px);text-shadow:0 6px 30px rgba(0,0,0,.6);opacity:0;transition:opacity .25s}
  .overlay{position:absolute;display:none;place-items:center;background:rgba(8,11,20,.72);backdrop-filter: blur(3px); pointer-events:auto;border-radius:18px; z-index:4}
  .overlay.show{display:grid}
  .card{max-width:min(720px,92vw);padding:20px;border-radius:18px;background:linear-gradient(180deg, rgba(22,28,46,.9), rgba(14,18,34,.88));border:1px solid rgba(255,255,255,.08);box-shadow:0 20px 60px rgba(0,0,0,.6);text-align:center}
  .title{margin:0 0 6px;font-size: clamp(24px, 5.2vw, 44px);font-weight:900}
  .sub{margin:0 0 12px;color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .btn{pointer-events:auto;border:none;border-radius:14px;padding:14px 18px;font-weight:800;cursor:pointer;color:#071022;background:linear-gradient(180deg,#ffd166,#ffb84d);box-shadow:0 10px 30px rgba(0,0,0,.45);font-size:18px}
  .btn.sec{background:#1c2546;color:var(--text);border:1px solid rgba(255,255,255,.12)}
  .modeBtn{min-width:220px;display:flex;align-items:center;gap:10px;justify-content:center}
  .modeBtn[data-active="true"]{outline:3px solid #ffd166}
  .alpha{margin-top:6px;font-weight:800;color:#ffd166;display:inline-flex;align-items:center;gap:8px}
  .alpha::before{content:"üõ†"}
  .stick{position:absolute;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);display:none;pointer-events:auto;touch-action:none; z-index:3}
  .stick::after{content:"";position:absolute;left:50%;top:50%;width:56px;height:56px;border-radius:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.25)}
  @media (hover:none) and (pointer:coarse){ .stick{display:block} }
  .action{position:absolute;width:118px;height:118px;border-radius:22px;background:var(--glass);border:1px solid var(--glassBorder);backdrop-filter: blur(6px);display:flex;align-items:center;justify-content:center;pointer-events:auto;touch-action:manipulation; transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease; z-index:3}
  .action .big{font-size:36px}
  .action:active{ transform: translateY(1px) scale(.99) }
  .action.disabled{opacity:.45;filter:grayscale(0.2); box-shadow:none}
  .action.ready{ border-color: rgba(255, 209, 102, 0.9); box-shadow: 0 0 0 0 rgba(255, 209, 102, 0.55), 0 12px 40px rgba(0,0,0,.5); animation: pulseGlow 1.2s ease-out infinite; }
  @keyframes pulseGlow{ 0%{ box-shadow: 0 0 0 0 rgba(255, 209, 102, 0.55), 0 12px 40px rgba(0,0,0,.5);} 70%{ box-shadow: 0 0 0 16px rgba(255, 209, 102, 0), 0 12px 40px rgba(0,0,0,.5);} 100%{ box-shadow: 0 0 0 0 rgba(255, 209, 102, 0), 0 12px 40px rgba(0,0,0,.5);} }
  .mute{position:absolute;right:12px;bottom:12px;border:none;border-radius:999px;padding:10px 12px;background:var(--glass);border:1px solid var(--glassBorder);color:var(--text);font-weight:800;pointer-events:auto; z-index:3}
  /* Intro */
  .intro{position:absolute;inset:0;display:none;place-items:center;text-align:center;z-index:5;background:radial-gradient(1200px 700px at 70% -10%, #1a2248, #080b14 60%);}
  .intro.show{display:grid; animation: fadeIn .6s ease forwards}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .intro .logo{font-size: clamp(28px, 7vw, 54px);font-weight:900}
  .intro .alpha{margin-top:10px}
  .intro .hint{margin-top:14px; color:var(--muted); font-size:14px}
</style>
</head>
<body>
<div class="wrap">
  <main>
    <div class="stage" id="stage">
      <canvas id="cv" width="900" height="900"></canvas>
      <div class="hudBox" id="hudBox">
        <div class="modeIcon" id="modeIcon">‚≠ê</div>
        <div class="score" id="scoreHUD">0</div>
        <div class="bank" id="bankHUD">‚Äî</div>
        <div class="morphBadge" id="morphBadge">ü¶Ñ Unicorn aktiv</div>
        <div class="event" id="eventHUD">KAOS!</div>
      </div>

      <!-- Intro overlay -->
      <div class="intro" id="introOv">
        <div class="card">
          <div class="logo">EMOJI DODGE</div>
          <div class="alpha">ALPHA BUILD v0.5 ‚Äì Under utveckling</div>
          <div class="hint">Tryck f√∂r att hoppa √∂ver</div>
        </div>
      </div>

      <!-- Start Menu -->
      <div class="overlay" id="startOv">
        <div class="card">
          <h1 class="title">V√§lj spell√§ge</h1>
          <div class="row" style="margin:10px 0 16px">
            <button class="btn modeBtn" id="btnClassic">‚≠ê Classic</button>
            <button class="btn modeBtn sec" id="btnDoge">üöÄ Doge World</button>
          </div>
          <div class="row">
            <button class="btn" id="startBtn" disabled style="opacity:.6">‚ñ∂ Starta</button>
            <button class="btn sec" id="muteBtnMenu">üîä Ljud</button>
          </div>
          <div class="alpha" style="margin-top:14px">Testversion ‚Äì feedback uppskattas!</div>
        </div>
      </div>

      <div class="overlay" id="overOv">
        <div class="card">
          <h2 class="title" style="margin:0 0 6px">Game Over üí•</h2>
          <p class="sub">Po√§ng: <b id="finalScore">0</b> ¬∑ B√§sta: <b id="finalBest">0</b></p>
          <div class="row">
            <button class="btn" id="retryBtn">üîÅ Spela igen</button>
            <button class="btn sec" id="menuBtn">üè† Meny</button>
          </div>
        </div>
      </div>

      <div class="stick" id="stick"></div>
      <button class="action" id="actionBtn" aria-label="Action"><div class="big" id="actionIcon">üí£</div></button>
      <button class="mute" id="muteBtn">üîä</button>
      <audio id="bgMusic" src="soundtrack.mp3" preload="auto" loop></audio>
    </div>
  </main>
</div>

<script>
// ===== Helpers
const images={};
function loadImage(key, src){ return new Promise(res=>{ const im=new Image(); im.onload=()=>{images[key]=im; res(true)}; im.onerror=()=>res(false); im.src=src; }); }
function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p); }
const AC=window.AudioContext||window.webkitAudioContext; let actx=null, muted=false;
function ensureAudio(){ if(!actx) actx=new AC(); }
function tone(f=900,d=0.07,t='triangle',v=0.035){ if(muted||!actx) return; const o=actx.createOscillator(), g=actx.createGain(); o.type=t;o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+d); }
function pingReady(){ tone(1100,0.09,'triangle',0.06); vibrate([10,40,10]); }

// Voices
function playRocketPickupVoice(){ if(muted) return; const a=new Audio('assets/to_the_moon.mp3'); a.volume=0.95; a.play().catch(()=>{}); }
function playCoinVoice(){ if(muted) return; const pick=Math.random()<0.5 ? 'assets/hodl.mp3' : 'assets/buy_the_dip.mp3'; const a=new Audio(pick); a.volume=0.9; a.play().catch(()=>{}); }
function playRocketWhoosh(){ if(muted) return; const a=new Audio('assets/rocket_whoosh.mp3'); a.volume=0.9; a.play().catch(()=>{}); }

// ===== Layout
const stage=document.getElementById('stage'), cv=document.getElementById('cv'), hudBox=document.getElementById('hudBox');
const stick=document.getElementById('stick'), actionBtn=document.getElementById('actionBtn'), actionIcon=document.getElementById('actionIcon');
const muteBtn=document.getElementById('muteBtn');
const modeIcon=document.getElementById('modeIcon');
const introOv=document.getElementById('introOv');
const startOv=document.getElementById('startOv');
const muteBtnMenu=document.getElementById('muteBtnMenu');
const btnClassic=document.getElementById('btnClassic'), btnDoge=document.getElementById('btnDoge');
const startBtn=document.getElementById('startBtn');
function layout(){
  const vw = window.visualViewport ? visualViewport.width : innerWidth;
  const vh = window.visualViewport ? visualViewport.height : innerHeight;
  const pad=12;
  const joy = Math.round(Math.max(110, Math.min(140, Math.min(vw, vh)*0.18)));
  stick.style.width=stick.style.height=joy+'px';
  const act=Math.round(joy*0.95); actionBtn.style.width=actionBtn.style.height=act+'px';
  // Square canvas centered
  const side = Math.max(320, Math.min(Math.min(vw, vh) - pad*2, 1100));
  const left = Math.round((vw-side)/2), top = Math.round((vh-side)/2);
  position(cv,left,top,side,side);
  // Controls anchored to canvas corners
  stick.style.left=Math.round(left+12)+'px'; stick.style.top=Math.round(top+side-joy-12)+'px';
  actionBtn.style.left=Math.round(left+side-act-12)+'px'; actionBtn.style.top=Math.round(top+side-act-12)+'px';
  const r=cv.getBoundingClientRect();
  positionBox('hudBox', r); positionBox('startOv', r); positionBox('overOv', r); positionBox('introOv', r);
  muteBtn.style.left=Math.round(r.right-60)+'px'; muteBtn.style.top=Math.round(r.bottom-44)+'px';
}
function position(el,x,y,w,h){ el.style.left=x+'px'; el.style.top=y+'px'; el.style.width=w+'px'; el.style.height=h+'px'; }
function positionBox(id,r){ const el=document.getElementById(id); if(!el) return; el.style.left=r.left+'px'; el.style.top=r.top+'px'; el.style.width=r.width+'px'; el.style.height=r.height+'px'; }
addEventListener('resize',layout); if (window.visualViewport) visualViewport.addEventListener('resize',layout);

// ===== HUD & State
const HUD={ score:scoreHUD, bank:bankHUD, event:eventHUD, start:startOv, over:overOv, finalScore:finalScore, finalBest:finalBest };
const STORAGE_KEY='emoji_dodge_v351_best'; let best=parseInt(localStorage.getItem(STORAGE_KEY)||'0',10);

const THEMES={ classicHaz:['üí£','üî•','‚ö°','üß®','üßä','üå©Ô∏è','üòà','üëæ','‚òÑÔ∏è','üåÄ','üó°Ô∏è'], fun:['üëª','üíÄ','üï∑Ô∏è','üï∏Ô∏è','üçî','üçï','üåÆ','üçü','üèÄ','üéØ','üé±'] };

const music=bgMusic;
function tryPlayMusic(){ if(muted) return; music.volume=0.7; music.play().catch(()=>{}); }
muteBtn.addEventListener('click', ()=>{ muted=!muted; muteBtn.textContent=muted?'üîá':'üîä'; if(muted){ music.pause(); } else tryPlayMusic(); }, {passive:true});
muteBtnMenu.addEventListener('click', ()=>{ muted=!muted; muteBtnMenu.textContent=muted?'üîá Ljud':'üîä Ljud'; if(muted){ music.pause(); } }, {passive:true});

// Game state
let running=false, themeSel=null; // 'classic' or 'doge'
let t=0,last=0,dt=0,score=0;
let hazards=[],stars=[],bombParts=[],coins=[],rockets=[],particles=[],sweeps=[];
const player={x:cv.width/2,y:cv.height*0.78,r:26,spd:370,emoji:'üòÄ'};
let bombCount=0, bombArmed=false;
let rocketCount=0, rocketArmed=false, rocketActive=0, shield=0, invul=0, spawnGrace=0;
const ROCKET_TIME=2.0;
let dogeImg=null, coinImg=null;
const playfieldMargin=24;

// Morph (Classic only)
let classicStars=0, morph='base';
let unicornTimer=0;

// Clamp
function clampPlayer(){ const minX=playfieldMargin+player.r, maxX=cv.width-playfieldMargin-player.r, minY=playfieldMargin+player.r, maxY=cv.height-playfieldMargin-player.r; if(player.x<minX) player.x=minX; if(player.x>maxX) player.x=maxX; if(player.y<minY) player.y=minY; if(player.y>maxY) player.y=maxY; }

// Input
const keys={ArrowUp:0,ArrowDown:0,ArrowLeft:0,ArrowRight:0,KeyW:0,KeyA:0,KeyS:0,KeyD:0,Space:0};
addEventListener('keydown',e=>{ if(e.code in keys) keys[e.code]=1; if(e.code==='Space') doAction(); });
addEventListener('keyup',e=>{ if(e.code in keys) keys[e.code]=0; });

retryBtn.addEventListener('click', e=>{ e.preventDefault(); ensureAudio(); start(); }, {passive:false});
menuBtn.addEventListener('click', e=>{ e.preventDefault(); HUD.over.classList.remove('show'); startMenu(); }, {passive:false});

// Intro flow
function showIntro(){
  introOv.classList.add('show');
  setTimeout(()=>{ if(introOv.classList.contains('show')) { introOv.classList.remove('show'); startMenu(); } }, 2500);
}
introOv.addEventListener('click', ()=>{ introOv.classList.remove('show'); startMenu(); }, {passive:true});

// Menu
btnClassic.addEventListener('click', ()=>selectMode('classic'));
btnDoge.addEventListener('click', ()=>selectMode('doge'));
function selectMode(m){
  themeSel=m;
  btnClassic.dataset.active = (m==='classic');
  btnDoge.dataset.active = (m==='doge');
  btnClassic.classList.toggle('sec', !(m==='classic'));
  btnDoge.classList.toggle('sec', !(m==='doge'));
  startBtn.disabled=false; startBtn.style.opacity='1';
}
startBtn.addEventListener('click', async e=>{ e.preventDefault(); if(!themeSel) return; ensureAudio(); await preloadAssets(); start(); }, {passive:false});

function startMenu(){
  HUD.start.classList.add('show'); layout();
}

function setModeIcon(){
  modeIcon.textContent = themeSel==='doge' ? 'üöÄ' : '‚≠ê';
  actionIcon.textContent = themeSel==='doge' ? 'üöÄ' : 'üí£';
}

// Preload
async function preloadAssets(){ const d1=await loadImage('doge','assets/doge.png'); if(d1) dogeImg=images['doge']; const d2=await loadImage('coin','assets/dogecoin.png'); if(d2) coinImg=images['coin']; }

// Joystick
let stickActive=false, stickStart=null, stickVec={x:0,y:0};
['touchstart','touchmove','touchend','touchcancel'].forEach(tp=>stick.addEventListener(tp,ev=>{
  if(tp==='touchstart'){ stickActive=true; const r=stick.getBoundingClientRect(); const t=ev.touches[0]; stickStart={x:t.clientX-(r.left+r.width/2), y:t.clientY-(r.top+r.height/2)}; stickVec={x:0,y:0}; }
  else if(tp==='touchmove'){ const r=stick.getBoundingClientRect(); const t=ev.touches[0]; const dx=t.clientX-(r.left+r.width/2)-stickStart.x; const dy=t.clientY-(r.top+r.height/2)-stickStart.y; const m=Math.hypot(dx,dy); const lim=r.width*0.45; const cl=Math.min(lim,m); const nx=m?dx/m:0, ny=m?dy/m:0; stickVec={x:(cl/lim)*nx,y:(cl/lim)*ny}; }
  else { stickActive=false; stickVec={x:0,y:0}; }
  ev.preventDefault();
},{passive:false}));

actionBtn.addEventListener('click', e=>{ e.preventDefault(); doAction(); }, {passive:false});

// Core
function start(){
  // reset
  hazards.length=0; stars.length=0; bombParts.length=0; coins.length=0; rockets.length=0; particles.length=0; sweeps.length=0;
  score=0; t=0; last=0;
  player.x=cv.width/2; player.y=cv.height*0.78; player.emoji=(themeSel==='doge'?'üê∂':'üòÄ');
  bombCount=0; bombArmed=false; rocketCount=0; rocketArmed=false; rocketActive=0; shield=0; invul=0; spawnGrace=0;
  classicStars=0; morph='base'; unicornTimer=0; morphBadge.classList.remove('show');
  running=true; HUD.start.classList.remove('show'); HUD.over.classList.remove('show');
  setModeIcon(); updateHUDTop();
  tryPlayMusic(); requestAnimationFrame(loop);
}
function startFirstTime(){ layout(); showIntro(); }

function updateHUDTop(){ HUD.bank.textContent = themeSel==='classic' ? ('üí£ '+bombCount+'/3') : ('üöÄ '+rocketCount+'/3'); }

function gameOver(){ running=false; const s=Math.floor(score); HUD.finalScore.textContent=s; if(s>best){ best=s; localStorage.setItem(STORAGE_KEY,String(best)); } HUD.finalBest.textContent=best; HUD.over.classList.add('show'); }

// Spawns
function spawnHazard(){ const arr=themeSel==='classic'?THEMES.classicHaz:THEMES.fun; const baseR=18+Math.random()*32; const speedScale=(baseR<22?1.45:1.0);
  hazards.push({x:Math.random()*(cv.width-2*playfieldMargin)+playfieldMargin,y:-40,r:baseR,vy:(150+Math.random()*220+Math.min(280,score*0.6))*speedScale,vx:(Math.random()-0.5)*90,rot:Math.random()*Math.PI*2,spin:(Math.random()-0.5)*2,emoji:arr[Math.floor(Math.random()*arr.length)]}); }
function spawnStar(){ stars.push({x:playfieldMargin+30+Math.random()*(cv.width-60-2*playfieldMargin),y:-30,r:22,vy:150+Math.random()*120,emoji:'‚≠ê',pulse:Math.random()*Math.PI*2}); }
function spawnBombPart(){ bombParts.push({x:playfieldMargin+30+Math.random()*(cv.width-60-2*playfieldMargin),y:-30,r:20,vy:150+Math.random()*120,emoji:'üí£',pulse:Math.random()*Math.PI*2}); }
function spawnCoin(){ coins.push({x:playfieldMargin+30+Math.random()*(cv.width-60-2*playfieldMargin),y:-30,r:20,vy:150+Math.random()*120,emoji:'ü™ô',pulse:Math.random()*Math.PI*2}); }
function spawnRocket(){ rockets.push({x:playfieldMargin+30+Math.random()*(cv.width-60-2*playfieldMargin),y:-30,r:20,vy:150+Math.random()*120,emoji:'üöÄ',pulse:Math.random()*Math.PI*2}); }

function addParticles(x,y,n=14,color='#fff'){ for(let i=0;i<n;i++) particles.push({x,y,vx:(Math.random()-0.5)*230,vy:(Math.random()-0.5)*230,life:0.7+Math.random()*0.5,color}); }
function toast(txt){ eventHUD.textContent=txt; eventHUD.style.opacity=1; setTimeout(()=>eventHUD.style.opacity=0,900); }

// Specials
function doAction(){ if(themeSel==='doge') activateRocket(); else detonateBomb(); }

function detonateBomb(){ if(!running || !bombArmed) return; bombArmed=false; bombCount=0; updateHUDTop(); hazards.forEach(h=>addParticles(h.x,h.y,22,'#ffb3b3')); hazards.length=0; toast('üí£'); vibrate([30,50,30]); actionBtn.classList.remove('ready'); }

function activateRocket(){
  if(!running || !rocketArmed || rocketActive>0) return;
  rocketArmed=false; rocketCount=0; updateHUDTop();
  rocketActive=ROCKET_TIME; invul=0;
  setTimeout(()=>{ try{ playRocketWhoosh(); }catch(e){} }, 120);
  toast('üöÄ'); vibrate([30,40,30]);
  actionBtn.classList.remove('ready');
}

function landRocket(){
  const radius=180; let kept=[];
  hazards.forEach(h=>{ const d=Math.hypot(h.x-player.x,h.y-player.y); if(d<radius){ addParticles(h.x,h.y,18,'#ffd166'); score+=10; } else kept.push(h); });
  hazards=kept;
  shield=3.0; invul=1.0; spawnGrace=1.6; toast('üõ°');
}

// ===== Loop
let lastReadyClassic=false, lastReadyDoge=false;
function loop(now){
  if(!running) return; requestAnimationFrame(loop);
  if(!last) last=now; dt=(now-last)/1000; last=now;

  // timers (doge flight/shield)
  if(themeSel==='doge'){
    const topStop=24+80+player.r;
    if(rocketActive>0){
      const ix=(keys.ArrowRight||keys.KeyD?1:0)-(keys.ArrowLeft||keys.KeyA?1:0) + (stickActive?stickVec.x*1.2:0);
      player.x += ix*player.spd*dt; player.y -= 520*dt*(0.6+0.4*Math.cos((rocketActive/ROCKET_TIME)*Math.PI));
      if(player.y<topStop) player.y=topStop;
      rocketActive=Math.max(0, rocketActive-dt);
      if(rocketActive===0) landRocket();
    }
    if(shield>0) shield=Math.max(0, shield-dt);
    if(invul>0) invul=Math.max(0, invul-dt);
    if(spawnGrace>0) spawnGrace=Math.max(0, spawnGrace-dt);
  }

  // pacing
  let hazardInt=Math.max(0.22, 0.85 - score*0.0022);
  if(spawnGrace>0) hazardInt*=1.7;
  const starInt=Math.max(0.68, 1.45 - score*0.0015);
  const coinInt=starInt;
  const specialInt=1.8;
  t+=dt;
  if(t % hazardInt < dt) spawnHazard();
  if(themeSel==='classic' && t % starInt < dt) spawnStar();
  if(themeSel==='doge' && t % coinInt < dt) spawnCoin();
  if(t % specialInt < dt){
    if(themeSel==='classic' && Math.random()<0.55) spawnBombPart();
    if(themeSel==='doge' && Math.random()<0.55) spawnRocket();
  }

  // input (normal)
  if(rocketActive<=0){
    let ix=(keys.ArrowRight||keys.KeyD?1:0)-(keys.ArrowLeft||keys.KeyA?1:0);
    let iy=(keys.ArrowDown||keys.KeyS?1:0)-(keys.ArrowUp||keys.KeyW?1:0);
    if(stickActive){ ix+=stickVec.x*1.2; iy+=stickVec.y*1.2; }
    const mag=Math.hypot(ix,iy)||1;
    player.x += (ix/mag)*player.spd*dt;
    player.y += (iy/mag)*player.spd*dt;
    player.y += 100*dt;
  }
  clampPlayer();

  // hazards
  for(let i=hazards.length-1;i>=0;i--){
    const h=hazards[i];
    h.y += (150+Math.min(280,score*0.6))*dt; h.x += h.vx*dt; h.rot += h.spin*dt;
    if(h.x<h.r+24 || h.x>cv.width-h.r-24) h.vx*=-1;
    const hit=((player.x-h.x)**2+(player.y-h.y)**2) <= (player.r+h.r)**2;
    if(hit){
      if(themeSel==='doge' && (shield>0 || invul>0 || rocketActive>0)){
        if(shield>0){ shield=0; toast('üí•'); }
        hazards.splice(i,1); continue;
      }
      return gameOver();
    }
    if(h.y-h.r>cv.height+60) hazards.splice(i,1);
  }

  // stars
  for(let i=stars.length-1;i>=0;i--){
    const g=stars[i]; g.y += g.vy*dt; g.pulse+=dt*3;
    if((player.x-g.x)**2+(player.y-g.y)**2 <= (player.r+g.r)**2){
      score+=25; classicStars+=1; addParticles(g.x,g.y,20,'#ffd166'); stars.splice(i,1);
      if(themeSel==='classic' && morph==='base' && classicStars>=5){
        morph='unicorn'; player.emoji='ü¶Ñ'; morphBadge.classList.add('show'); toast('ü¶Ñ Unicorn!');
      }
      continue;
    }
    if(g.y-g.r>cv.height+40) stars.splice(i,1);
  }

  // bomb parts
  for(let i=bombParts.length-1;i>=0;i--){
    const b=bombParts[i]; b.y += b.vy*dt; b.pulse+=dt*3;
    if((player.x-b.x)**2+(player.y-b.y)**2 <= (player.r+b.r)**2){
      bombCount = Math.min(3, bombCount+1); addParticles(b.x,b.y,18,'#ffb3b3'); bombParts.splice(i,1); updateHUDTop();
      if(bombCount>=3 && !bombArmed){ bombArmed=true; actionBtn.classList.add('ready'); pingReady(); }
      continue;
    }
    if(b.y-b.r>cv.height+40) bombParts.splice(i,1);
  }

  // coins
  for(let i=coins.length-1;i>=0;i--){
    const c=coins[i]; c.y += c.vy*dt; c.pulse+=dt*3;
    if((player.x-c.x)**2+(player.y-c.y)**2 <= (player.r+c.r)**2){
      score+=30; addParticles(c.x,c.y,20,'#ffe28a'); coins.splice(i,1); playCoinVoice(); continue;
    }
    if(c.y-c.r>cv.height+40) coins.splice(i,1);
  }

  // rockets (pickups)
  for(let i=rockets.length-1;i>=0;i--){
    const m=rockets[i]; m.y += m.vy*dt; m.pulse+=dt*3;
    if((player.x-m.x)**2+(player.y-m.y)**2 <= (player.r+m.r)**2){
      rocketCount = Math.min(3, rocketCount+1); addParticles(m.x,m.y,18,'#cfe8ff'); rockets.splice(i,1); updateHUDTop(); playRocketPickupVoice();
      if(rocketCount>=3 && !rocketArmed){ rocketArmed=true; actionBtn.classList.add('ready'); pingReady(); }
      continue;
    }
    if(m.y-m.r>cv.height+40) rockets.splice(i,1);
  }

  // unicorn passive (classic)
  if(themeSel==='classic' && morph==='unicorn'){
    unicornTimer -= dt;
    if(unicornTimer<=0){
      unicornTimer = 3.8;
      const y = 24 + 60 + Math.random()*(cv.height-120-48);
      sweeps.push({x:-160, y, w:180, h:110, speed:520, life:1.4, t:0});
    }
  }

  // update sweeps + clear hazards
  for(let i=sweeps.length-1;i>=0;i--){
    const s=sweeps[i]; s.t+=dt; s.x += s.speed*dt; if(s.x>cv.width+200 || s.t>s.life){ sweeps.splice(i,1); continue; }
    for(let j=hazards.length-1;j>=0;j--){
      const h=hazards[j];
      if(h.y> s.y - s.h/2 && h.y < s.y + s.h/2 && h.x > s.x - s.w/2 && h.x < s.x + s.w/2){
        addParticles(h.x,h.y,16,'#ff9de6'); hazards.splice(j,1);
      }
    }
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.life-=dt; if(p.life<=0){ particles.splice(i,1); continue; } p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=380*dt; }

  // Ready pulse guard
  const readyClassic = themeSel==='classic' && bombArmed;
  const readyDoge = themeSel==='doge' && rocketArmed;
  if(readyClassic && !lastReadyClassic){ pingReady(); } 
  if(readyDoge && !lastReadyDoge){ pingReady(); }
  lastReadyClassic = readyClassic; lastReadyDoge = readyDoge;

  score += dt*4;
  scoreHUD.textContent=''+Math.floor(score);
  draw();
}

// ===== Draw
function draw(){
  const ctx=cv.getContext('2d'); ctx.clearRect(0,0,cv.width,cv.height);
  // background watermark per mode
  ctx.save();
  ctx.globalAlpha = 0.06;
  ctx.font = `${Math.floor(cv.width*0.7)}px serif`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  const mark = themeSel==='doge' ? 'üöÄ' : '‚≠ê';
  ctx.fillText(mark, cv.width/2, cv.height/2);
  ctx.restore();

  // grid
  ctx.save(); ctx.globalAlpha=0.05; ctx.strokeStyle='#cbd5ff';
  const grid=90; ctx.beginPath();
  for(let gx=24;gx<cv.width-24;gx+=grid){ ctx.moveTo(gx,24); ctx.lineTo(gx,cv.height-24); }
  for(let gy=24;gy<cv.height-24;gy+=grid){ ctx.moveTo(24,gy); ctx.lineTo(cv.width-24,gy); }
  ctx.stroke(); ctx.restore();

  // shield/invul
  if(shield>0){ const a=Math.max(0.15, 0.25*Math.sin(Date.now()/180)+0.3); ctx.save(); ctx.globalAlpha=a; ctx.strokeStyle='#ffd166'; ctx.lineWidth=12; ctx.beginPath(); ctx.arc(player.x,player.y, player.r+18, 0, Math.PI*2); ctx.stroke(); ctx.restore(); }
  if(invul>0){ ctx.save(); ctx.globalAlpha=0.22; ctx.strokeStyle='#8dfcff'; ctx.lineWidth=6; ctx.beginPath(); ctx.arc(player.x,player.y, player.r+28, 0, Math.PI*2); ctx.stroke(); ctx.restore(); }

  // particles
  particles.forEach(p=>{ ctx.save(); ctx.globalAlpha=Math.max(0,p.life); ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,2.2,0,Math.PI*2); ctx.fill(); ctx.restore(); });

  // sweeps (rainbow band)
  sweeps.forEach(s=>{
    const g=ctx.createLinearGradient(s.x-s.w/2, s.y, s.x+s.w/2, s.y);
    g.addColorStop(0,'#ff2d55'); g.addColorStop(0.2,'#ffcc00'); g.addColorStop(0.4,'#34c759'); g.addColorStop(0.6,'#5ac8fa'); g.addColorStop(0.8,'#5856d6'); g.addColorStop(1,'#ff2d55');
    ctx.save(); ctx.globalAlpha=0.45; ctx.fillStyle=g;
    ctx.fillRect(s.x-s.w/2, s.y-s.h/2, s.w, s.h);
    ctx.restore();
  });

  // stars
  stars.forEach(g=>{
    const pulse=0.35+0.18*Math.sin(g.pulse*2);
    ctx.save(); ctx.globalAlpha=0.35+pulse; ctx.strokeStyle='#ffd166'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(g.x,g.y,g.r+12,0,Math.PI*2); ctx.stroke(); ctx.restore();
    drawEmoji('‚≠ê', g.x,g.y, g.r*2+4*Math.sin(g.pulse), 0, '#ffd166');
  });

  // bomb parts
  bombParts.forEach(b=>{
    const pulse=0.35+0.18*Math.sin(b.pulse*2);
    ctx.save(); ctx.globalAlpha=0.35+pulse; ctx.strokeStyle='#ffb3b3'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(b.x,b.y,b.r+10,0,Math.PI*2); ctx.stroke(); ctx.restore();
    drawEmoji('üí£', b.x,b.y, b.r*2+2*Math.sin(b.pulse), 0, '#ffb3b3');
  });

  // coins
  coins.forEach(cn=>{
    const pulse=0.35+0.18*Math.sin(cn.pulse*2);
    ctx.save(); ctx.globalAlpha=0.35+pulse; ctx.strokeStyle='#ffe28a'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(cn.x,cn.y,cn.r+10,0,Math.PI*2); ctx.stroke(); ctx.restore();
    if(images['coin']){ ctx.save(); ctx.translate(cn.x, cn.y); ctx.drawImage(images['coin'], -cn.r, -cn.r, cn.r*2, cn.r*2); ctx.restore(); }
    else { drawEmoji('ü™ô', cn.x,cn.y, cn.r*2+2*Math.sin(cn.pulse), 0, '#ffe28a'); }
  });

  // rocket pickups
  rockets.forEach(m=>{
    const pulse=0.35+0.18*Math.sin(m.pulse*2);
    ctx.save(); ctx.globalAlpha=0.35+pulse; ctx.strokeStyle='#cfe8ff'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(m.x,m.y,m.r+10,0,Math.PI*2); ctx.stroke(); ctx.restore();
    drawEmoji('üöÄ', m.x,m.y, m.r*2+2*Math.sin(m.pulse), 0, '#cfe8ff');
  });

  // hazards
  hazards.forEach(h=>{
    ctx.save(); ctx.globalAlpha=0.38; ctx.strokeStyle='#ff6b6b'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(h.x,h.y,h.r+12,0,Math.PI*2); ctx.stroke(); ctx.restore();
    drawEmoji(h.emoji, h.x,h.y, h.r*2, h.rot, '#ff6b6b');
  });

  // player
  if(themeSel==='doge' && images['doge']){ const s=player.r*2; ctx.save(); ctx.translate(player.x, player.y); ctx.drawImage(images['doge'], -s/2, -s/2, s, s); ctx.restore(); }
  else drawEmoji(player.emoji, player.x, player.y, player.r*2, 0, '#f1f5ff');
}

function drawEmoji(e,x,y,size,rot,glow){ const ctx=cv.getContext('2d'); ctx.save(); ctx.translate(x,y); ctx.rotate(rot); ctx.font=`${size}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; if(glow){ ctx.shadowColor=glow; ctx.shadowBlur=14; ctx.shadowOffsetY=2; } ctx.fillText(e,0,0); ctx.restore(); }

// Boot
HUD.score.textContent='0'; HUD.bank.textContent='‚Äî'; layout(); startFirstTime();
</script>
</body>
</html>
