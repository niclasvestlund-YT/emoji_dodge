<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Emoji Dodge ‚Äì v2.5 Square Arena</title>
<meta name="theme-color" content="#0b0f1a" />
<meta property="og:title" content="Emoji Dodge ‚Äì v2.5" />
<meta property="og:description" content="Meme-UI, kaos-events, haptics och kvadratisk arena som k√§nns likadan i st√•ende och liggande." />
<meta property="og:type" content="website" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ctext y='50' font-size='48'%3E%F0%9F%98%8E%3C/text%3E%3C/svg%3E">
<style>
  :root{ --bg:#080b14; --text:#f1f5ff; --muted:#9aa5c3; --gold:#ffd166; --red:#ff6b6b; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 70% -10%, #182046, #080b14 60%);color:var(--text);font-family:ui-sans-serif,system-ui,Inter,Arial}
  .wrap{display:flex;flex-direction:column;min-height:100dvh}
  main{position:relative;flex:1;display:grid;place-items:center;overflow:hidden;padding:8px}
  .stage{position:relative;display:grid;place-items:center;max-width:100%;max-height:100%}
  /* Square canvas: logical 900x900, scaled with CSS to a square that fits viewport */
  canvas{display:block;border-radius:18px;border:1px solid rgba(255,255,255,.08);box-shadow:0 12px 40px rgba(0,0,0,.5);background: radial-gradient(800px 500px at 50% -100px, rgba(255,255,255,.05), transparent 60%), linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); touch-action:none}
  .hud{position:absolute;inset:0;pointer-events:none}
  .score{position:absolute;left:calc(14px + env(safe-area-inset-left));top:calc(10px + env(safe-area-inset-top));font-weight:900;font-size: clamp(26px,5vw,42px);text-shadow:0 4px 16px rgba(0,0,0,.45)}
  .best{position:absolute;left:calc(14px + env(safe-area-inset-left));top:calc(56px + env(safe-area-inset-top));font-weight:800;opacity:.9;font-size: clamp(14px,2.6vw,18px)}
  .modePill{
    position:absolute;right:calc(12px + env(safe-area-inset-right));top:calc(12px + env(safe-area-inset-top));
    font-weight:800;font-size: clamp(14px,2.6vw,18px);
    background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);
    padding:10px 14px;border-radius:999px;pointer-events:auto;user-select:none;touch-action:manipulation;
    display:flex;align-items:center;gap:8px;backdrop-filter: blur(4px);
  }
  .modePill:active{transform:scale(.98)}
  .event{position:absolute;left:50%;top:14%;transform:translateX(-50%);font-weight:900;font-size: clamp(22px,3.6vw,36px);text-shadow:0 6px 30px rgba(0,0,0,.6);opacity:0;transition:opacity .25s}
  .overlay{position:absolute;inset:0;display:grid;place-items:center;background:rgba(8,11,20,.72);backdrop-filter: blur(2px); pointer-events:auto}
  .card{max-width:min(760px,92vw);padding:22px;border-radius:18px;background:linear-gradient(180deg, rgba(22,28,46,.88), rgba(14,18,34,.86));border:1px solid rgba(255,255,255,.08);box-shadow:0 20px 60px rgba(0,0,0,.6);text-align:center}
  .title{margin:0 0 6px;font-size: clamp(26px, 4.2vw, 46px);font-weight:900}
  .sub{margin:0 0 14px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .btn{pointer-events:auto;border:none;border-radius:12px;padding:14px 18px;font-weight:800;cursor:pointer;color:#071022;background:var(--gold);box-shadow:0 10px 30px rgba(0,0,0,.45);font-size:18px}
  .btn.sec{background:#1c2546;color:var(--text);border:1px solid rgba(255,255,255,.12)}
  .select{appearance:none;background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:10px 12px}
  .tiny{font-size:12px;color:var(--muted)}
  .stick{position:absolute;left:14px;bottom:calc(14px + env(safe-area-inset-bottom));width:124px;height:124px;border-radius:50%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);display:none}
  .stick::after{content:"";position:absolute;left:50%;top:50%;width:64px;height:64px;border-radius:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.25)}
  @media (hover:none) and (pointer:coarse){ .stick{display:block} }
  .shake{animation:shake .18s ease-in-out}
  @keyframes shake{0%{transform:translate3d(0,0,0)}25%{transform:translate3d(2px,0,0)}50%{transform:translate3d(-2px,0,0)}75%{transform:translate3d(2px,0,0)}100%{transform:translate3d(0,0,0)}}
</style>
</head>
<body>
<div class="wrap">
  <main>
    <div class="stage" id="stage">
      <canvas id="cv" width="900" height="900" aria-label="Spelyta kvadrat"></canvas>
      <div class="hud">
        <div class="score" id="scoreHUD">‚≠ê 0</div>
        <div class="best" id="bestHUD">üèÜ 0</div>
        <button class="modePill" id="modePill" aria-label="Byt l√§ge">‚≠ê Samla ‚ü≥</button>
        <div class="event" id="eventHUD">KAOS!</div>
      </div>

      <div class="overlay" id="start">
        <div class="card">
          <h1 class="title">Emoji Dodge v2.5</h1>
          <p class="sub">Kvadratisk arena (samma storlek i st√•ende/liggande). Haptics, kaos-events, mode-knapp. Tap/click f√∂r att starta.</p>
          <div class="row" style="margin-bottom:10px">
            <button class="btn" id="startBtn">‚ñ∂ Starta</button>
            <select class="select" id="themeSel">
              <option value="default">Standard</option>
              <option value="spooky">Spooky üëª</option>
              <option value="food">Mat ü•ë</option>
              <option value="sports">Sport üèÄ</option>
              <option value="flags">Flaggor üö©</option>
            </select>
            <select class="select" id="modeSelStart">
              <option value="collect">‚≠ê Samla</option>
              <option value="dodge">üö´ Undvik</option>
            </select>
          </div>
          <div class="tiny">Tips: P√• iPhone k√∂rs b√§sta helsk√§rm via ‚ÄúL√§gg till p√• hemsk√§rmen‚Äù.</div>
        </div>
      </div>

      <div class="overlay" id="over" style="display:none">
        <div class="card">
          <h2 class="title" style="margin:0 0 6px">Game Over üí•</h2>
          <p class="sub">Po√§ng: <b id="finalScore">0</b> ¬∑ B√§sta: <b id="finalBest">0</b></p>
          <div class="row">
            <button class="btn" id="retryBtn">üîÅ Spela igen</button>
            <button class="btn sec" id="menuBtn">üè† Meny</button>
            <button class="btn sec" id="shareBtn">üì§ Dela</button>
          </div>
        </div>
      </div>

      <div class="stick" id="stick"></div>
    </div>
  </main>
</div>

<script>
// ======= Canvas & HUD =======
const cv = document.getElementById('cv');
const ctx = cv.getContext('2d');
const HUD = {
  score: document.getElementById('scoreHUD'),
  best: document.getElementById('bestHUD'),
  event: document.getElementById('eventHUD'),
  start: document.getElementById('start'),
  over: document.getElementById('over'),
  finalScore: document.getElementById('finalScore'),
  finalBest: document.getElementById('finalBest'),
  themeSel: document.getElementById('themeSel'),
  modeSelStart: document.getElementById('modeSelStart'),
  modePill: document.getElementById('modePill'),
  stage: document.getElementById('stage')
};

// ======= Square Fit =======
function fitSquare(){
  const vw = window.visualViewport ? window.visualViewport.width : innerWidth;
  const vh = window.visualViewport ? window.visualViewport.height : innerHeight;
  const pad = 12 + Math.max(0, parseInt(getComputedStyle(document.body).padding||'0'));
  const s = Math.min(vw, vh) - pad*2; // square side in CSS px
  const side = Math.max(280, Math.min(s, 1100));
  cv.style.width = side + 'px';
  cv.style.height = side + 'px';
}
addEventListener('resize',fitSquare);
if (window.visualViewport) visualViewport.addEventListener('resize',fitSquare);
fitSquare();

// ======= Storage =======
const STORAGE_KEY='emoji_dodge_v25_best';
let best = parseInt(localStorage.getItem(STORAGE_KEY) || '0', 10);
HUD.best.textContent = 'üèÜ '+best;

// ======= Themes =======
const THEMES={
  default:['üí£','üî•','‚ö°','üß®','üßä','üå©Ô∏è','üòà','üëæ','‚òÑÔ∏è','üåÄ','üó°Ô∏è'],
  spooky:['üëª','üíÄ','üï∑Ô∏è','üï∏Ô∏è','üßü','üßõ','ü¶á','üîÆ'],
  food:['üçî','üçï','üåÆ','üçü','üç©','üçó','üç∞','üç£'],
  sports:['üèÄ','üèà','‚öΩ','üéØ','üé±','üèê','ü•ä','üéæ','üè∏'],
  flags:['üè¥‚Äç‚ò†Ô∏è','üö©','üá∏üá™','üáØüáµ','üá∫üá∏','üáßüá∑','üá™üá∏','üá©üá™','üá¨üáß']
};

// ======= Audio & Haptics =======
const AC = window.AudioContext || window.webkitAudioContext;
let actx=null, muted=false;
function ensureAudio(){ if(!actx) actx=new AC(); }
function tone(f=600,d=0.07,t='sine',v=0.025){ if(muted||!actx) return; const o=actx.createOscillator(); const g=actx.createGain(); o.type=t;o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+d); }
function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p); else shakeFallback(); }
function shakeFallback(){ HUD.stage.classList.remove('shake'); void HUD.stage.offsetWidth; HUD.stage.classList.add('shake'); tone(120,0.04,'sine',0.015); }
function boom(){ tone(80,0.25,'sawtooth',0.05); vibrate([20,30,40]); }
function bling(){ tone(900,0.08,'triangle',0.045); vibrate(15); }
function stinger(){ tone(520,0.12,'square',0.04); setTimeout(()=>tone(720,0.12,'square',0.04),120); vibrate([10,30,10]); }
function heartBeat(){ tone(200,0.05,'sine',0.03); setTimeout(()=>tone(160,0.05,'sine',0.03),90); vibrate(10); }
function wallBump(){ tone(280,0.03,'square',0.02); vibrate(8); }

// ======= Game State =======
let running=false, mode='collect', theme='default';
let t=0,last=0,dt=0,score=0,gravity=1,warp=1;
let hazards=[],goods=[],particles=[];
let autoEventTimer=0, fx={blur:0,blackout:0};
const player={x:cv.width/2,y:cv.height*0.78,r:26,spd:370,emoji:'üòé',evo:0};

// ======= Playfield Clamp (square) =======
const playfieldMargin = 22;
function clampPlayer(){
  const minX = playfieldMargin + player.r;
  const maxX = cv.width - playfieldMargin - player.r;
  const minY = playfieldMargin + player.r;
  const maxY = cv.height - playfieldMargin - player.r;
  let clamped=false;
  if(player.x < minX){ player.x = minX; clamped=true; }
  if(player.x > maxX){ player.x = maxX; clamped=true; }
  if(player.y < minY){ player.y = minY; clamped=true; }
  if(player.y > maxY){ player.y = maxY; clamped=true; }
  if(clamped) wallBump();
}

// ======= Input =======
const keys={ArrowUp:0,ArrowDown:0,ArrowLeft:0,ArrowRight:0,KeyW:0,KeyA:0,KeyS:0,KeyD:0,KeyM:0};
addEventListener('keydown',e=>{ if(e.code in keys) keys[e.code]=1; if(e.code==='KeyM') muted=!muted; });
addEventListener('keyup',e=>{ if(e.code in keys) keys[e.code]=0; });

// Mode pill
HUD.modePill.addEventListener('click', ()=>{
  mode = (mode==='collect') ? 'dodge' : 'collect';
  HUD.modePill.textContent = (mode==='collect') ? '‚≠ê Samla ‚ü≥' : 'üö´ Undvik ‚ü≥';
  stinger();
}, {passive:true});

// Start/Retry/Menu
document.getElementById('startBtn').addEventListener('click', (e)=>{ e.preventDefault(); ensureAudio(); setOptionsFromMenu(); start(); }, {passive:false});
document.getElementById('retryBtn').addEventListener('click', (e)=>{ e.preventDefault(); ensureAudio(); start(); }, {passive:false});
document.getElementById('menuBtn').addEventListener('click', (e)=>{ e.preventDefault(); HUD.over.style.display='none'; HUD.start.style.display='grid'; }, {passive:false});
cv.addEventListener('click', ()=>{ if(!running){ ensureAudio(); setOptionsFromMenu(); start(); } }, {passive:true});
HUD.start.addEventListener('click', ()=>{ if(!running){ ensureAudio(); setOptionsFromMenu(); start(); } }, {passive:true});

// Share
document.getElementById('shareBtn').addEventListener('click', async ()=>{
  const img = posterImage(Math.floor(score), best, theme, mode);
  try{
    if(navigator.canShare && navigator.canShare({files:[img]})){
      await navigator.share({ title:'Emoji Dodge', text:`Jag fick ${Math.floor(score)} po√§ng!`, files:[img] });
    } else {
      const url = URL.createObjectURL(img);
      const a = Object.assign(document.createElement('a'), {href:url, download:'emoji_dodge_score.png'});
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }
  }catch{}
});

function setOptionsFromMenu(){
  theme = HUD.themeSel.value;
  mode  = HUD.modeSelStart.value;
  HUD.modePill.textContent = (mode==='collect') ? '‚≠ê Samla ‚ü≥' : 'üö´ Undvik ‚ü≥';
}

// ======= Mobile Joystick =======
const stick=document.getElementById('stick');
let stickActive=false, stickStart=null, stickVec={x:0,y:0};
['touchstart','touchmove','touchend','touchcancel'].forEach(tp=>stick.addEventListener(tp,ev=>{
  if(tp==='touchstart'){ stickActive=true; const r=stick.getBoundingClientRect(); const t=ev.touches[0]; stickStart={x:t.clientX-(r.left+r.width/2), y:t.clientY-(r.top+r.height/2)}; stickVec={x:0,y:0}; }
  else if(tp==='touchmove'){ const r=stick.getBoundingClientRect(); const t=ev.touches[0]; const dx=t.clientX-(r.left+r.width/2)-stickStart.x; const dy=t.clientY-(r.top+r.height/2)-stickStart.y; const m=Math.hypot(dx,dy); const lim=52; const cl=Math.min(lim,m); const nx=m?dx/m:0, ny=m?dy/m:0; stickVec={x:(cl/lim)*nx,y:(cl/lim)*ny}; }
  else { stickActive=false; stickVec={x:0,y:0}; }
  ev.preventDefault();
},{passive:false}));

// ======= Core =======
function start(){
  hazards.length=0; goods.length=0; particles.length=0;
  score=0; t=0; gravity=1; warp=1; fx.blur=0; fx.blackout=0;
  player.x=cv.width/2; player.y=cv.height*0.78; player.evo=0; player.emoji='üòé';
  running=true; last=0;
  HUD.start.style.display='none'; HUD.over.style.display='none';
  requestAnimationFrame(loop);
}

function gameOver(){
  running=false; boom();
  const s=Math.floor(score);
  HUD.finalScore.textContent=s;
  if(s>best){ best=s; localStorage.setItem(STORAGE_KEY,String(best)); }
  HUD.finalBest.textContent=best;
  HUD.over.style.display='grid';
}

function spawnHazard(){
  const arr=THEMES[theme];
  const baseR=18 + Math.random()*32;
  const speedScale=(baseR<22?1.45:1.0);
  hazards.push({ x:Math.random()*(cv.width-2*playfieldMargin)+playfieldMargin, y:-40, r:baseR, vy:(150+Math.random()*220+Math.min(280,score*0.6))*speedScale, vx:(Math.random()-0.5)*90, rot:Math.random()*Math.PI*2, spin:(Math.random()-0.5)*2, emoji:arr[Math.floor(Math.random()*arr.length)] });
}
function spawnGood(){ goods.push({ x:playfieldMargin+30+Math.random()*(cv.width-60-2*playfieldMargin), y:-30, r:22, vy:150+Math.random()*120, emoji:'‚≠ê', pulse:Math.random()*Math.PI*2 }); }
function addParticles(x,y,n=14,color='#fff'){ for(let i=0;i<n;i++){ particles.push({x,y,vx:(Math.random()-0.5)*230,vy:(Math.random()-0.5)*230,life:0.7+Math.random()*0.5,color}); } }

function toast(txt){ HUD.event.textContent=txt; HUD.event.style.opacity=1; setTimeout(()=>HUD.event.style.opacity=0,1000); }

function triggerEvent(type){
  stinger(); // haptics bump at start of chaos
  if(type==='flip'){ gravity*=-1; toast('üåÄ Gravity Flip'); }
  if(type==='big'){ hazards.forEach(h=>h.r*=1.7); toast('üß† Everything Big'); }
  if(type==='blur'){ fx.blur=5; toast('üå´Ô∏è Blur Mode'); setTimeout(()=>fx.blur=0, 4500); }
  if(type==='banana'){ for(let i=0;i<14;i++) hazards.push({x:Math.random()*(cv.width-2*playfieldMargin)+playfieldMargin,y:-40,r:22+Math.random()*10,vy:200+Math.random()*180,vx:(Math.random()-0.5)*40,rot:0,spin:(Math.random()-0.5)*2,emoji:'üçå'}); toast('üçå Banana Rain'); }
  if(type==='warp'){ warp = (warp===1?1.55:1); toast(warp>1?'‚è±Ô∏è Speed Up':'‚è±Ô∏è Normal'); }
  if(type==='blackout'){ fx.blackout=1; toast('üåë Blackout'); setTimeout(()=>fx.blackout=0, 5500); }
}
function autoEvents(dt){ autoEventTimer+=dt; if(autoEventTimer>=28){ autoEventTimer=0; const arr=['flip','big','blur','banana','warp','blackout']; triggerEvent(arr[Math.floor(Math.random()*arr.length)]); } }
function evolve(elapsed){ const st=Math.floor(elapsed/24); if(st!==player.evo){ player.evo=st; player.emoji = st>=3?'ü¶Ñ':st==2?'ü§ñ':'ü§†'; toast('‚≠ê Evolverad!'); } }

function loop(now){
  if(!running) return;
  requestAnimationFrame(loop);
  if(!last) last=now; dt=((now-last)/1000)*warp; last=now;

  autoEvents(dt);
  evolve(score/4);

  // spawn pace
  const hazardInt=Math.max(0.16, 0.7 - score*0.0025);
  const goodInt=Math.max(0.68, 1.45 - score*0.0015);
  t+=dt;
  if(t % hazardInt < dt) spawnHazard();
  if(mode==='collect' && t % goodInt < dt) spawnGood();

  // input
  const up=keys.ArrowUp||keys.KeyW, down=keys.ArrowDown||keys.KeyS, left=keys.ArrowLeft||keys.KeyA, right=keys.ArrowRight||keys.KeyD;
  let ix=(right?1:0)-(left?1:0), iy=(down?1:0)-(up?1:0);
  if(stickActive){ ix += stickVec.x*1.2; iy += stickVec.y*1.2; }
  const mag=Math.hypot(ix,iy)||1;
  player.x += (ix/mag)*player.spd*dt;
  player.y += (iy/mag)*player.spd*dt;
  player.y += 100*gravity*dt;

  // clamp & near-miss
  const before={x:player.x,y:player.y};
  clampPlayer();
  // hazards
  let near=false;
  for(let i=hazards.length-1;i>=0;i--){
    const h=hazards[i];
    h.y += h.vy*dt*gravity; h.x += h.vx*dt; h.rot += h.spin*dt;
    if(h.x<h.r+playfieldMargin || h.x>cv.width-h.r-playfieldMargin) h.vx*=-1;
    const d2 = (player.x-h.x)**2+(player.y-h.y)**2;
    if(d2 < (player.r+h.r+30)**2 && d2 > (player.r+h.r)**2) near=true;
    if(d2 <= (player.r+h.r)**2){ return gameOver(); }
    if((gravity>0 && h.y-h.r>cv.height+60) || (gravity<0 && h.y+h.r<-60)) hazards.splice(i,1);
  }
  if(near && Math.random()<0.08) heartBeat();

  // goods
  if(mode==='collect'){
    for(let i=goods.length-1;i>=0;i--){
      const g=goods[i];
      g.y += g.vy*dt*gravity; g.pulse+=dt*3;
      if((player.x-g.x)**2+(player.y-g.y)**2 <= (player.r+g.r)**2){ score+=25; bling(); addParticles(g.x,g.y,20,'#ffd166'); goods.splice(i,1); continue; }
      if((gravity>0 && g.y-g.r>cv.height+40) || (gravity<0 && g.y+g.r<-40)) goods.splice(i,1);
    }
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.life-=dt; if(p.life<=0){ particles.splice(i,1); continue; }
    p.x += p.vx*dt; p.y += p.vy*dt; p.vy += 380*dt;
  }

  score += dt*4;
  HUD.score.textContent='‚≠ê '+Math.floor(score);

  draw();
}

function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  // grid within margin
  ctx.save(); ctx.globalAlpha=0.05; ctx.strokeStyle='#cbd5ff';
  const grid=90; ctx.beginPath();
  for(let gx=playfieldMargin;gx<cv.width-playfieldMargin;gx+=grid){ ctx.moveTo(gx,playfieldMargin); ctx.lineTo(gx,cv.height-playfieldMargin); }
  for(let gy=playfieldMargin;gy<cv.height-playfieldMargin;gy+=grid){ ctx.moveTo(playfieldMargin,gy); ctx.lineTo(cv.width-playfieldMargin,gy); }
  ctx.stroke(); ctx.restore();

  // particles
  particles.forEach(p=>{ ctx.save(); ctx.globalAlpha=Math.max(0,p.life); ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,2.2,0,Math.PI*2); ctx.fill(); ctx.restore(); });

  // goods
  goods.forEach(g=>{
    const pulse=0.35+0.18*Math.sin(g.pulse*2);
    ctx.save(); ctx.globalAlpha=0.35+pulse; ctx.strokeStyle='#ffd166'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(g.x,g.y,g.r+12,0,Math.PI*2); ctx.stroke(); ctx.restore();
    drawEmoji('‚≠ê', g.x,g.y, g.r*2+4*Math.sin(g.pulse), 0, '#ffd166');
  });

  // hazards
  hazards.forEach(h=>{
    ctx.save(); ctx.globalAlpha=0.38; ctx.strokeStyle='#ff6b6b'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(h.x,h.y,h.r+12,0,Math.PI*2); ctx.stroke(); ctx.restore();
    drawEmoji(h.emoji, h.x,h.y, h.r*2, h.rot, '#ff6b6b');
  });

  drawEmoji(player.emoji, player.x, player.y, player.r*2, 0, '#f1f5ff');
}

function addParticles(x,y,n=14,color='#fff'){ for(let i=0;i<n;i++){ particles.push({x,y,vx:(Math.random()-0.5)*230,vy:(Math.random()-0.5)*230,life:0.7+Math.random()*0.5,color}); } }
function drawEmoji(e,x,y,size,rot,glow){
  ctx.save();
  ctx.translate(x,y); ctx.rotate(rot);
  ctx.font = `${size}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
  if(glow){ ctx.shadowColor=glow; ctx.shadowBlur=14; ctx.shadowOffsetY=2; }
  ctx.fillText(e,0,0);
  ctx.restore();
}

// ======= Poster Share =======
function posterImage(score, best, theme, mode){
  const w=1200,h=630;
  const can=document.createElement('canvas'); can.width=w; can.height=h;
  const c=can.getContext('2d');
  // bg
  const grd=c.createLinearGradient(0,0,0,h); grd.addColorStop(0,'#0b0f1a'); grd.addColorStop(1,'#111a33'); c.fillStyle=grd; c.fillRect(0,0,w,h);
  c.fillStyle='rgba(255,255,255,.07)'; for(let x=0;x<w;x+=60){ c.fillRect(x,0,1,h);} for(let y=0;y<h;y+=60){ c.fillRect(0,y,w,1);}
  // title
  c.font='bold 64px system-ui, sans-serif'; c.fillStyle='#f1f5ff'; c.fillText('Emoji Dodge', 60, 120);
  c.font='28px system-ui, sans-serif'; c.fillStyle='#9aa5c3'; c.fillText('v2.5 ‚Äì Square Arena', 60, 160);
  // score
  c.font='bold 110px system-ui, sans-serif'; c.fillStyle='#ffd166'; c.fillText('‚≠ê ' + score, 60, 300);
  c.font='bold 42px system-ui, sans-serif'; c.fillStyle='#cbd5ff'; c.fillText('üèÜ B√§sta: ' + best, 60, 360);
  // mode/theme
  c.font='32px system-ui, sans-serif'; c.fillStyle='#9aa5c3'; c.fillText((mode==='collect'?'‚≠ê Samla':'üö´ Undvik') + ' ¬∑ Tema: ' + theme, 60, 420);
  // player emoji
  c.font='140px serif'; c.fillText('üòé', w-220, h-120);
  // export
  const data = can.toDataURL('image/png');
  const bin = atob(data.split(',')[1]); const buf = new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) buf[i]=bin.charCodeAt(i);
  return new File([buf], 'emoji_dodge_score.png', {type:'image/png'});
}
</script>
</body>
</html>
