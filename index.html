<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Emoji Dodge ‚Äì v2.7 Bomb Power</title>
<meta name="theme-color" content="#0b0f1a" />
<style>
  :root{ --bg:#080b14; --text:#f1f5ff; --muted:#9aa5c3; --gold:#ffd166; --red:#ff6b6b; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 70% -10%, #182046, #080b14 60%);color:var(--text);font-family:ui-sans-serif,system-ui,Inter,Arial;overscroll-behavior:none}
  .wrap{display:flex;flex-direction:column;min-height:100dvh}
  main{position:relative;flex:1;overflow:hidden}
  .stage{position:relative;width:100%;height:100%}
  canvas{position:absolute;display:block;border-radius:18px;border:1px solid rgba(255,255,255,.08);box-shadow:0 12px 40px rgba(0,0,0,.5);background: radial-gradient(800px 500px at 50% -100px, rgba(255,255,255,.05), transparent 60%), linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01)); touch-action:none}
  .hudBox{position:absolute;pointer-events:none}
  .score{position:absolute;left:14px;top:10px;font-weight:900;font-size: clamp(22px, 4.5vw, 36px);text-shadow:0 4px 16px rgba(0,0,0,.45)}
  .bank{position:absolute;left:14px;top:48px;font-weight:800;opacity:.95;font-size: clamp(14px, 3.2vw, 20px)}
  .modePill{position:absolute;right:12px;top:12px;font-weight:800;font-size: clamp(13px,2.6vw,18px);background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);padding:9px 12px;border-radius:999px;pointer-events:auto;user-select:none;touch-action:manipulation;display:flex;align-items:center;gap:8px;backdrop-filter: blur(4px)}
  .modePill:active{transform:scale(.98)}
  .event{position:absolute;left:50%;top:14%;transform:translateX(-50%);font-weight:900;font-size: clamp(20px,3.6vw,32px);text-shadow:0 6px 30px rgba(0,0,0,.6);opacity:0;transition:opacity .25s}
  .overlay{position:absolute;display:none;place-items:center;background:rgba(8,11,20,.72);backdrop-filter: blur(2px); pointer-events:auto;border-radius:18px}
  .overlay.show{display:grid}
  .card{max-width:min(720px,92vw);padding:20px;border-radius:18px;background:linear-gradient(180deg, rgba(22,28,46,.88), rgba(14,18,34,.86));border:1px solid rgba(255,255,255,.08);box-shadow:0 20px 60px rgba(0,0,0,.6);text-align:center}
  .title{margin:0 0 6px;font-size: clamp(24px, 4.2vw, 44px);font-weight:900}
  .sub{margin:0 0 12px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
  .btn{pointer-events:auto;border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;color:#071022;background:var(--gold);box-shadow:0 10px 30px rgba(0,0,0,.45);font-size:16px}
  .btn.sec{background:#1c2546;color:var(--text);border:1px solid rgba(255,255,255,.12)}
  .select{appearance:none;background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:8px 10px}
  .stick{position:absolute;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);display:none;pointer-events:auto;touch-action:none}
  .stick::after{content:"";position:absolute;left:50%;top:50%;width:56px;height:56px;border-radius:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.25)}
  @media (hover:none) and (pointer:coarse){ .stick{display:block} }
  /* Right-thumb action button */
  .action{position:absolute;width:118px;height:118px;border-radius:50%;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);backdrop-filter: blur(4px);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;pointer-events:auto;touch-action:manipulation}
  .action .big{font-size:36px}
  .action .label{font-weight:900;font-size:16px}
  .action .cost{font-weight:800;font-size:14px;color:var(--muted)}
  .action.disabled{opacity:.45;filter:grayscale(0.2)}
  .shake{animation:shake .18s ease-in-out}
  @keyframes shake{0%{transform:translate3d(0,0,0)}25%{transform:translate3d(2px,0,0)}50%{transform:translate3d(-2px,0,0)}75%{transform:translate3d(2px,0,0)}100%{transform:translate3d(0,0,0)}}
</style>
</head>
<body>
<div class="wrap">
  <main>
    <div class="stage" id="stage">
      <canvas id="cv" width="900" height="900"></canvas>
      <div class="hudBox" id="hudBox">
        <div class="score" id="scoreHUD">‚≠ê 0</div>
        <div class="bank" id="bankHUD">üí∞ 0</div>
        <button class="modePill" id="modePill">‚≠ê Samla ‚ü≥</button>
        <div class="event" id="eventHUD">KAOS!</div>
      </div>

      <div class="overlay" id="startOv">
        <div class="card">
          <h1 class="title">Emoji Dodge v2.7</h1>
          <p class="sub">Nyhet: **Bombknapp** f√∂r h√∂gertummen ‚Äì rensar sk√§rmen. Kostar ‚≠ê. Joystick ligger alltid utanf√∂r spelytan.</p>
          <div class="row" style="margin-bottom:10px">
            <button class="btn" id="startBtn">‚ñ∂ Starta</button>
            <select class="select" id="themeSel">
              <option value="default">Standard</option>
              <option value="spooky">Spooky üëª</option>
              <option value="food">Mat ü•ë</option>
              <option value="sports">Sport üèÄ</option>
              <option value="flags">Flaggor üö©</option>
            </select>
            <select class="select" id="modeSelStart">
              <option value="collect">‚≠ê Samla</option>
              <option value="dodge">üö´ Undvik</option>
            </select>
          </div>
          <div class="sub" style="font-size:12px">Tips: Samla ‚≠ê f√∂r att ladda bomben. iPhone: b√§st helsk√§rm via ‚ÄúL√§gg till p√• hemsk√§rmen‚Äù.</div>
        </div>
      </div>

      <div class="overlay" id="overOv">
        <div class="card">
          <h2 class="title" style="margin:0 0 6px">Game Over üí•</h2>
          <p class="sub">Po√§ng: <b id="finalScore">0</b> ¬∑ B√§sta: <b id="finalBest">0</b></p>
          <div class="row">
            <button class="btn" id="retryBtn">üîÅ Spela igen</button>
            <button class="btn sec" id="menuBtn">üè† Meny</button>
          </div>
        </div>
      </div>

      <div class="stick" id="stick"></div>
      <button class="action" id="actionBtn" aria-label="Bomb">
        <div class="big">üí£</div>
        <div class="label">Bomb</div>
        <div class="cost" id="costHUD">kostar ‚≠ê5</div>
      </button>
    </div>
  </main>
</div>

<script>
// ===== Layout & safe areas =====
const stage = document.getElementById('stage');
const cv = document.getElementById('cv');
const hudBox = document.getElementById('hudBox');
const stick = document.getElementById('stick');
const actionBtn = document.getElementById('actionBtn');
const costHUD = document.getElementById('costHUD');

function layout(){
  const vw = window.visualViewport ? window.visualViewport.width : innerWidth;
  const vh = window.visualViewport ? window.visualViewport.height : innerHeight;
  const isLandscape = vw > vh;
  const pad = 12;
  // joystick/action size from shorter side
  const joy = Math.round(Math.max(110, Math.min(140, Math.min(vw, vh)*0.18)));
  stick.style.width = stick.style.height = joy + 'px';
  const act = Math.round(joy*0.95);
  actionBtn.style.width = actionBtn.style.height = act + 'px';

  let side, left, top;
  if(isLandscape){
    const gutterL = joy + 24;
    const gutterR = act + 24;
    side = Math.min(vh - pad*2, vw - pad*2 - gutterL - gutterR);
    side = Math.max(320, Math.min(side, 1100));
    left = Math.round((vw - (side + gutterL + gutterR))/2 + gutterL);
    top  = Math.round((vh - side)/2);
    position(cv,left,top,side,side);
    // left joystick center, right action center
    stick.style.left = Math.round(left - joy - 16) + 'px';
    stick.style.top  = Math.round(top + (side - joy)/2) + 'px';
    actionBtn.style.left = Math.round(left + side + 16) + 'px';
    actionBtn.style.top  = Math.round(top + (side - act)/2) + 'px';
  }else{
    // portrait: reserve bottom gutter for joystick/action side by side
    side = Math.min(vw - pad*2, vh - pad*2 - (joy + 28));
    side = Math.max(320, Math.min(side, 1100));
    left = Math.round((vw - side)/2);
    top  = Math.round((vh - (side + joy + 20))/2);
    position(cv,left,top,side,side);
    // joystick left under, action right under
    const underY = Math.round(top + side + 8);
    stick.style.left = Math.round(left + side*0.5 - joy - 10) + 'px';
    stick.style.top  = underY + 'px';
    actionBtn.style.left = Math.round(left + side*0.5 + 10) + 'px';
    actionBtn.style.top  = underY + 'px';
  }
  // HUD & overlays sized to canvas rect
  const r = cv.getBoundingClientRect();
  positionBox('hudBox', r); positionBox('startOv', r); positionBox('overOv', r);
}

function position(el,x,y,w,h){ el.style.left=x+'px'; el.style.top=y+'px'; el.style.width=w+'px'; el.style.height=h+'px'; }
function positionBox(id, r){ const el=document.getElementById(id); el.style.left=r.left+'px'; el.style.top=r.top+'px'; el.style.width=r.width+'px'; el.style.height=r.height+'px'; }

addEventListener('resize',layout);
if (window.visualViewport) visualViewport.addEventListener('resize',layout);
layout();

// ===== HUD & State =====
const HUD = {
  score: document.getElementById('scoreHUD'),
  bank: document.getElementById('bankHUD'),
  event: document.getElementById('eventHUD'),
  start: document.getElementById('startOv'),
  over: document.getElementById('overOv'),
  finalScore: document.getElementById('finalScore'),
  finalBest: document.getElementById('finalBest'),
  themeSel: document.getElementById('themeSel'),
  modeSelStart: document.getElementById('modeSelStart'),
  modePill: document.getElementById('modePill')
};

const STORAGE_KEY='emoji_dodge_v27_best';
let best = parseInt(localStorage.getItem(STORAGE_KEY) || '0', 10);

// Themes
const THEMES={
  default:['üí£','üî•','‚ö°','üß®','üßä','üå©Ô∏è','üòà','üëæ','‚òÑÔ∏è','üåÄ','üó°Ô∏è'],
  spooky:['üëª','üíÄ','üï∑Ô∏è','üï∏Ô∏è','üßü','üßõ','ü¶á','üîÆ'],
  food:['üçî','üçï','üåÆ','üçü','üç©','üçó','üç∞','üç£'],
  sports:['üèÄ','üèà','‚öΩ','üéØ','üé±','üèê','ü•ä','üéæ','üè∏'],
  flags:['üè¥‚Äç‚ò†Ô∏è','üö©','üá∏üá™','üáØüáµ','üá∫üá∏','üáßüá∑','üá™üá∏','üá©üá™','üá¨üáß']
};

// Audio + Haptics
const AC = window.AudioContext || window.webkitAudioContext;
let actx=null, muted=false;
function ensureAudio(){ if(!actx) actx=new AC(); }
function tone(f=600,d=0.07,t='sine',v=0.025){ if(muted||!actx) return; const o=actx.createOscillator(); const g=actx.createGain(); o.type=t;o.frequency.value=f; g.gain.value=v; o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+d); }
function vibrate(p){ if(navigator.vibrate) navigator.vibrate(p); else shakeFallback(); }
function shakeFallback(){ stage.classList.remove('shake'); void stage.offsetWidth; stage.classList.add('shake'); tone(120,0.04,'sine',0.015); }
function boom(){ tone(80,0.25,'sawtooth',0.05); vibrate([20,30,40]); }
function bling(){ tone(900,0.08,'triangle',0.045); vibrate(15); }
function stinger(){ tone(520,0.12,'square',0.04); setTimeout(()=>tone(720,0.12,'square',0.04),120); vibrate([10,30,10]); }
function heartBeat(){ tone(200,0.05,'sine',0.03); setTimeout(()=>tone(160,0.05,'sine',0.03),90); vibrate(10); }
function wallBump(){ tone(280,0.03,'square',0.02); vibrate(8); }

// Game state
let running=false, mode='collect', theme='default';
let t=0,last=0,dt=0,score=0,gravity=1,warp=1;
let hazards=[],goods=[],particles=[];
let autoEventTimer=0;
const fx={blur:0,blackout:0};
const player={x:cv.width/2,y:cv.height*0.78,r:26,spd:370,emoji:'üòé',evo:0};

// Currency & power
let bank=0, bombCooldown=0;
const BOMB_COST=5, BOMB_COOLDOWN_S=3;

// Clamp
const playfieldMargin = 24;
function clampPlayer(){
  const minX = playfieldMargin + player.r;
  const maxX = cv.width - playfieldMargin - player.r;
  const minY = playfieldMargin + player.r;
  const maxY = cv.height - playfieldMargin - player.r;
  let clamped=false;
  if(player.x < minX){ player.x = minX; clamped=true; }
  if(player.x > maxX){ player.x = maxX; clamped=true; }
  if(player.y < minY){ player.y = minY; clamped=true; }
  if(player.y > maxY){ player.y = maxY; clamped=true; }
  if(clamped) wallBump();
}

// Input
const keys={ArrowUp:0,ArrowDown:0,ArrowLeft:0,ArrowRight:0,KeyW:0,KeyA:0,KeyS:0,KeyD:0,KeyM:0,Space:0};
addEventListener('keydown',e=>{ if(e.code in keys) keys[e.code]=1; if(e.code==='KeyM') muted=!muted; if(e.code==='Space') tryBomb(); });
addEventListener('keyup',e=>{ if(e.code in keys) keys[e.code]=0; });

// Mode pill
HUD.modePill.addEventListener('click', ()=>{
  mode = (mode==='collect') ? 'dodge' : 'collect';
  HUD.modePill.textContent = (mode==='collect') ? '‚≠ê Samla ‚ü≥' : 'üö´ Undvik ‚ü≥';
  stinger();
}, {passive:true});

// Start/Retry/Menu
document.getElementById('startBtn').addEventListener('click', (e)=>{ e.preventDefault(); ensureAudio(); setOptionsFromMenu(); start(); }, {passive:false});
document.getElementById('retryBtn').addEventListener('click', (e)=>{ e.preventDefault(); ensureAudio(); start(); }, {passive:false});
document.getElementById('menuBtn').addEventListener('click', (e)=>{ e.preventDefault(); HUD.over.classList.remove('show'); HUD.start.classList.add('show'); }, {passive:false});
cv.addEventListener('click', ()=>{ if(!running){ ensureAudio(); setOptionsFromMenu(); start(); } }, {passive:true});

// Action button
actionBtn.addEventListener('click', (e)=>{ e.preventDefault(); tryBomb(); }, {passive:false});

function setOptionsFromMenu(){
  theme = HUD.themeSel.value;
  mode  = HUD.modeSelStart.value;
  HUD.modePill.textContent = (mode==='collect') ? '‚≠ê Samla ‚ü≥' : 'üö´ Undvik ‚ü≥';
}

// Joystick
let stickActive=false, stickStart=null, stickVec={x:0,y:0};
['touchstart','touchmove','touchend','touchcancel'].forEach(tp=>stick.addEventListener(tp,ev=>{
  if(tp==='touchstart'){ stickActive=true; const r=stick.getBoundingClientRect(); const t=ev.touches[0]; stickStart={x:t.clientX-(r.left+r.width/2), y:t.clientY-(r.top+r.height/2)}; stickVec={x:0,y:0}; }
  else if(tp==='touchmove'){ const r=stick.getBoundingClientRect(); const t=ev.touches[0]; const dx=t.clientX-(r.left+r.width/2)-stickStart.x; const dy=t.clientY-(r.top+r.height/2)-stickStart.y; const m=Math.hypot(dx,dy); const lim=r.width*0.45; const cl=Math.min(lim,m); const nx=m?dx/m:0, ny=m?dy/m:0; stickVec={x:(cl/lim)*nx,y:(cl/lim)*ny}; }
  else { stickActive=false; stickVec={x:0,y:0}; }
  ev.preventDefault();
},{passive:false}));

// Core
function start(){
  hazards.length=0; goods.length=0; particles.length=0;
  score=0; bank=0; t=0; gravity=1; warp=1; fx.blur=0; fx.blackout=0; bombCooldown=0;
  player.x=cv.width/2; player.y=cv.height*0.78; player.evo=0; player.emoji='üòé';
  running=true; last=0;
  HUD.start.classList.remove('show'); HUD.over.classList.remove('show');
  updateBankHUD(); updateActionState();
  requestAnimationFrame(loop);
}

function gameOver(){
  running=false; boom();
  const s=Math.floor(score);
  document.getElementById('finalScore').textContent=s;
  if(s>best){ best=s; localStorage.setItem(STORAGE_KEY,String(best)); }
  document.getElementById('finalBest').textContent=best;
  HUD.over.classList.add('show');
}

function spawnHazard(){
  const arr=THEMES[theme];
  const baseR=18 + Math.random()*32;
  const speedScale=(baseR<22?1.45:1.0);
  hazards.push({ x:Math.random()*(cv.width-2*playfieldMargin)+playfieldMargin, y:-40, r:baseR, vy:(150+Math.random()*220+Math.min(280,score*0.6))*speedScale, vx:(Math.random()-0.5)*90, rot:Math.random()*Math.PI*2, spin:(Math.random()-0.5)*2, emoji:arr[Math.floor(Math.random()*arr.length)] });
}
function spawnGood(){ goods.push({ x:playfieldMargin+30+Math.random()*(cv.width-60-2*playfieldMargin), y:-30, r:22, vy:150+Math.random()*120, emoji:'‚≠ê', pulse:Math.random()*Math.PI*2 }); }
function addParticles(x,y,n=14,color='#fff'){ for(let i=0;i<n;i++){ particles.push({x,y,vx:(Math.random()-0.5)*230,vy:(Math.random()-0.5)*230,life:0.7+Math.random()*0.5,color}); } }

function toast(txt){ HUD.event.textContent=txt; HUD.event.style.opacity=1; setTimeout(()=>HUD.event.style.opacity=0,1000); }

function triggerEvent(type){
  stinger();
  if(type==='flip'){ gravity*=-1; toast('üåÄ Gravity Flip'); }
  if(type==='big'){ hazards.forEach(h=>h.r*=1.7); toast('üß† Everything Big'); }
  if(type==='blur'){ toast('üå´Ô∏è Blur Mode'); setTimeout(()=>{}, 0); }
  if(type==='banana'){ for(let i=0;i<14;i++) hazards.push({x:Math.random()*(cv.width-2*playfieldMargin)+playfieldMargin,y:-40,r:22+Math.random()*10,vy:200+Math.random()*180,vx:(Math.random()-0.5)*40,rot:0,spin:(Math.random()-0.5)*2,emoji:'üçå'}); toast('üçå Banana Rain'); }
  if(type==='warp'){ warp = (warp===1?1.55:1); toast(warp>1?'‚è±Ô∏è Speed Up':'‚è±Ô∏è Normal'); }
  if(type==='blackout'){ toast('üåë Blackout'); }
}
function autoEvents(dt){ autoEventTimer+=dt; if(autoEventTimer>=28){ autoEventTimer=0; const arr=['flip','big','blur','banana','warp','blackout']; triggerEvent(arr[Math.floor(Math.random()*arr.length)]); } }
function evolve(elapsed){ const st=Math.floor(elapsed/24); if(st!==player.evo){ player.evo=st; player.emoji = st>=3?'ü¶Ñ':st==2?'ü§ñ':'ü§†'; toast('‚≠ê Evolverad!'); } }

function loop(now){
  if(!running) return;
  requestAnimationFrame(loop);
  if(!last) last=now; dt=((now-last)/1000)*warp; last=now;

  if(bombCooldown>0){ bombCooldown=Math.max(0, bombCooldown-dt); if(bombCooldown===0) updateActionState(); }

  autoEvents(dt);
  evolve(score/4);

  // spawn pace
  const hazardInt=Math.max(0.16, 0.7 - score*0.0025);
  const goodInt=Math.max(0.68, 1.45 - score*0.0015);
  t+=dt;
  if(t % hazardInt < dt) spawnHazard();
  if(mode==='collect' && t % goodInt < dt) spawnGood();

  // input
  const up=keys.ArrowUp||keys.KeyW, down=keys.ArrowDown||keys.KeyS, left=keys.ArrowLeft||keys.KeyA, right=keys.ArrowRight||keys.KeyD;
  let ix=(right?1:0)-(left?1:0), iy=(down?1:0)-(up?1:0);
  if(stickActive){ ix += stickVec.x*1.2; iy += stickVec.y*1.2; }
  const mag=Math.hypot(ix,iy)||1;
  player.x += (ix/mag)*player.spd*dt;
  player.y += (iy/mag)*player.spd*dt;
  player.y += 100*gravity*dt;
  clampPlayer();

  // hazards
  let near=false;
  for(let i=hazards.length-1;i>=0;i--){
    const h=hazards[i];
    h.y += h.vy*dt*gravity; h.x += h.vx*dt; h.rot += h.spin*dt;
    if(h.x<h.r+playfieldMargin || h.x>cv.width-h.r-playfieldMargin) h.vx*=-1;
    const d2 = (player.x-h.x)**2+(player.y-h.y)**2;
    if(d2 < (player.r+h.r+30)**2 && d2 > (player.r+h.r)**2) near=true;
    if(d2 <= (player.r+h.r)**2){ return gameOver(); }
    if((gravity>0 && h.y-h.r>cv.height+60) || (gravity<0 && h.y+h.r<-60)) hazards.splice(i,1);
  }
  if(near && Math.random()<0.08) heartBeat();

  // goods
  if(mode==='collect'){
    for(let i=goods.length-1;i>=0;i--){
      const g=goods[i];
      g.y += g.vy*dt*gravity; g.pulse+=dt*3;
      if((player.x-g.x)**2+(player.y-g.y)**2 <= (player.r+g.r)**2){
        score+=25; bank+=1; bling(); updateBankHUD(); updateActionState();
        addParticles(g.x,g.y,20,'#ffd166'); goods.splice(i,1); continue;
      }
      if((gravity>0 && g.y-g.r>cv.height+40) || (gravity<0 && g.y+g.r<-40)) goods.splice(i,1);
    }
  }

  // particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.life-=dt; if(p.life<=0){ particles.splice(i,1); continue; }
    p.x += p.vx*dt; p.y += p.vy*dt; p.vy += 380*dt;
  }

  score += dt*4;
  HUD.score.textContent='‚≠ê '+Math.floor(score);

  draw();
}

function draw(){
  const ctx = cv.getContext('2d');
  ctx.clearRect(0,0,cv.width,cv.height);
  // grid
  ctx.save(); ctx.globalAlpha=0.05; ctx.strokeStyle='#cbd5ff';
  const grid=90; ctx.beginPath();
  for(let gx=playfieldMargin;gx<cv.width-playfieldMargin;gx+=grid){ ctx.moveTo(gx,playfieldMargin); ctx.lineTo(gx,cv.height-playfieldMargin); }
  for(let gy=playfieldMargin;gy<cv.height-playfieldMargin;gy+=grid){ ctx.moveTo(playfieldMargin,gy); ctx.lineTo(cv.width-playfieldMargin,gy); }
  ctx.stroke(); ctx.restore();

  // particles
  particles.forEach(p=>{ ctx.save(); ctx.globalAlpha=Math.max(0,p.life); ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,2.2,0,Math.PI*2); ctx.fill(); ctx.restore(); });

  // goods
  goods.forEach(g=>{
    const pulse=0.35+0.18*Math.sin(g.pulse*2);
    ctx.save(); ctx.globalAlpha=0.35+pulse; ctx.strokeStyle='#ffd166'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(g.x,g.y,g.r+12,0,Math.PI*2); ctx.stroke(); ctx.restore();
    drawEmoji('‚≠ê', g.x,g.y, g.r*2+4*Math.sin(g.pulse), 0, '#ffd166');
  });

  // hazards
  hazards.forEach(h=>{
    ctx.save(); ctx.globalAlpha=0.38; ctx.strokeStyle='#ff6b6b'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(h.x,h.y,h.r+12,0,Math.PI*2); ctx.stroke(); ctx.restore();
    drawEmoji(h.emoji, h.x,h.y, h.r*2, h.rot, '#ff6b6b');
  });

  drawEmoji(player.emoji, player.x, player.y, player.r*2, 0, '#f1f5ff');
}

function drawEmoji(e,x,y,size,rot,glow){
  const ctx=cv.getContext('2d');
  ctx.save();
  ctx.translate(x,y); ctx.rotate(rot);
  ctx.font = `${size}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
  if(glow){ ctx.shadowColor=glow; ctx.shadowBlur=14; ctx.shadowOffsetY=2; }
  ctx.fillText(e,0,0);
  ctx.restore();
}

// ===== Bomb Power =====
function tryBomb(){
  if(!running) return;
  if(bombCooldown>0 || bank < BOMB_COST) { shakeFallback(); return; }
  bank -= BOMB_COST; updateBankHUD(); updateActionState();
  // clear hazards with VFX & points
  let cleared=0;
  hazards.forEach(h=>{ addParticles(h.x,h.y,24,'#ffb3b3'); });
  cleared = hazards.length;
  hazards.length=0;
  tone(80,0.25,'sawtooth',0.08); tone(120,0.2,'sawtooth',0.06); vibrate([40,60,40]);
  toast('üí£ Mega Bomb!');
  score += cleared * 10;
  bombCooldown = BOMB_COOLDOWN_S;
  updateActionState();
}

function updateBankHUD(){ HUD.bank.textContent = 'üí∞ '+bank; }
function updateActionState(){
  const ready = bank >= BOMB_COST && bombCooldown===0;
  actionBtn.classList.toggle('disabled', !ready);
  if(bombCooldown>0){
    costHUD.textContent = 'cooldown ' + Math.ceil(bombCooldown)+'s';
  } else {
    costHUD.textContent = 'kostar ‚≠ê'+BOMB_COST;
  }
}

// ===== Start state =====
HUD.start.classList.add('show');
HUD.bank.textContent = 'üí∞ 0';
HUD.score.textContent = '‚≠ê 0';
layout();
</script>
</body>
</html>
